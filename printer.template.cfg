## DO NOT EDIT THIS FILE, IT IS A TEMPLATE. THAT YOU NEED TO COPY
# Prusa MK3s Klipper Config

# The first thing you'll need to do is go through this file and comment out / uncomment
# the files and/or settings you need.

# You'll be able to print just fine with this config as it is, but it is recommended
# that you follow these steps to properly calibrate your printer:

# 0) Sanity check and PID Tuning: https://www.klipper3d.org/Config_checks.html
# 1) Pressure Advance: https://www.klipper3d.org/Pressure_Advance.html
# 2) Skew Correction: https://www.klipper3d.org/skew_correction.html
# 3) Resonance Compensation: https://www.klipper3d.org/Resonance_Compensation.html

# Read more about klipper here: https://www.klipper3d.org/Overview.html

### UI
[include mainsail.cfg]
# [include fluidd.cfg]

# Input Shaping
[input_shaper]
shaper_freq_x: 25.0
shaper_freq_y: 25.0
shaper_type: mzv

# ADXL
#[include adxl.cfg]

[mcu]
# serial: /dev/serial0 # If you are using internal RPI serial port
# serial: /dev/ttyACM0 # If you are using RPI via USB connection to printer
serial: /dev/serial/by-id/usb-Prusa_Research__prusa3d.com__Original_Prusa_i3_MK3_CZPX1721X004XC75467-if00
restart_method: command

[exclude_object]

### CONTROL BOARD
[include klipper-prusa-mk3s/mk3s/einsy-rambo.cfg]

### BASE SETUP
[include klipper-prusa-mk3s/mk3s/display.cfg]
[include klipper-prusa-mk3s/mk3s/steppers.cfg]
[include klipper-prusa-mk3s/mk3s/tmc2130.cfg]

### Disable OctoPrint Menu
[menu __main __octoprint]
type: disabled

### EXTRUSION

# Extruder
# [include klipper-prusa-mk3s/extruders/prusa.cfg]
[include klipper-prusa-mk3s/extruders/bmg.cfg]

# Hotend
[include klipper-prusa-mk3s/hotends/v6.cfg]
# [include klipper-prusa-mk3s/hotends/dragon-standard-flow.cfg]
# [include klipper-prusa-mk3s/hotends/rapido.cfg]

[idle_timeout]
gcode:
    SET_STEPPER_ENABLE STEPPER=extruder ENABLE=0 # disable the extruder motor
    M104 S0 # set hotend to 0C
#   A list of G-Code commands to execute on an idle timeout. See
#   docs/Command_Templates.md for G-Code format. The default is to run
#   "TURN_OFF_HEATERS" and "M84".
timeout: 21600
#   Idle time (in seconds) to wait before running the above G-Code
#   commands. The default is 600 seconds.

[extruder]
# To tune Pressure Advance see https://www.klipper3d.org/Pressure_Advance.html
# default is already set based on hotend, but you can further improve prints by calibrating it to your nozzle and material
# pressure_advance: 0.05
nozzle_diameter: 0.4 # Remember to change this if you change nozzle diameter.
control: pid
pid_Kp: 23.073
pid_Ki: 1.424
pid_Kd: 93.446

[heater_bed]
pid_Kp: 51.348
pid_Ki: 0.669
pid_Kd: 985.880

[bed_screws]
screw1: 128,110
screw1_name: Center

screw2: 13,6
screw2_name: Front Left

screw3: 13,115
screw3_name: Front Center

screw4: 13,210
screw4_name: Front Right

screw5: 123,6
screw5_name: Center Left

screw6: 123,210
screw6_name: Center Right

screw7: 228,6
screw7_name: Back Left

screw8: 228,115
screw8_name: Back Center

screw9: 228,210
screw9_name: Back Right

[screws_tilt_adjust]
# SW Nylock Mod: Screw 1 uses the 6mm metallic spacer so its
# height is considered the baseline. For tilt adjust using the
# command SCREWS_TILT_CALCULATE or MACRO ADJUST_BED_SCREWS, this has to be your Screw 1:
#
# ******************
# * S7 S8 S9 *
# * *
# Bed: * S5 S1 S6 *
# * *
# * S2 S3 S4 *
# ******************
#
screw1: 128,110
screw1_name: Center
screw2: 13,6
screw2_name: Front Left
screw3: 13,115
screw3_name: Front Center
screw4: 13,210
screw4_name: Front Right
screw5: 123,6
screw5_name: Center Left
screw6: 123,210
screw6_name: Center Right
screw7: 228,6
screw7_name: Back Left
screw8: 228,115
screw8_name: Back Center
screw9: 228,210
screw9_name: Back Right
horizontal_move_z: 10.
speed: 50.
screw_thread: CCW-M3

## copy this from your current setting on Prusa, but make it absolute (removing -)
[probe]
x_offset: 24
z_offset = 1.560

## For faster printing enable
[printer]
max_velocity: 300
max_accel: 4000
minimum_cruise_ratio:0.5
max_z_velocity: 30
max_z_accel: 300

## For stealth mode enable

# [tmc2130 stepper_x]
# interpolate: True
# stealthchop_threshold: 80
# [tmc2130 stepper_y]
# interpolate: True
# stealthchop_threshold: 80
# [tmc2130 stepper_z]
# interpolate: True
# stealthchop_threshold: 80

[safe_z_home]
home_xy_position: 100,100

## Custom bed mest probes
## Prusa has 3x3 or 7x7, you can do any variation you want
[bed_mesh]
mesh_min: 35, 6
mesh_max: 240,198
probe_count: 7,7
zero_reference_position: 103.32, 102.00 #Generate mesh relative to center post for nylock.
mesh_pps: 0,0 #Don't generate interperlated points so our mesh is compatible with nylock calculators like https://pcboy.github.io/g81_relative/

# Linear correction
# Check `extruders/linear-correction` for more informations.
[include klipper-prusa-mk3s/extruders/linear-correction/linear-correction-0.cfg] # Default Prusa linear correction optimized for LDO motors

### MACROS
[include klipper-prusa-mk3s/macros.cfg]

# Menu Items
[menu __main __setup __calib __Ajust_Bed_Screws]
type: command
enable: {not printer.idle_timeout.state == "Printing"}
name: Adjust Bed Screws
gcode:
    ADJUST_BED_SCREWS

# FIRST RUN: 
# Execute these sequentially in the console, let PID tuning finish before saving
# PID_CALIBRATE HEATER=extruder TARGET=170
# SAVE_CONFIG
# PID_CALIBRATE HEATER=heater_bed TARGET=60
# SAVE_CONFIG

# You can also skip the above setting for stock Prusa and use
# [extruder]
# control: pid
# min_temp: 0
# max_temp: 305
# min_extrude_temp: 170


### The end, on the end the printer will store it's tuning data, so do not edit it.
