[gcode_macro M600]
description: Filament change procedure
gcode:
    {% set X = params.X|default(0)|float %}
    {% set Y = params.Y|default(0)|float %}
    {% set Z = params.Z|default(10)|float %}
    {% set TEMP = params.TEMP|default(220)|float %}
    # Save current printer state
    SAVE_GCODE_STATE NAME=M600_state
    # Disable filament sensor (if applicable)
    SET_FILAMENT_SENSOR SENSOR=fsensor ENABLE=0
    # Retract filament slightly to prevent oozing
    G92 E0
    G91
    G1 E-3 F2700  ; Slightly more retraction to ensure filament retraction
    G90
    # Pause the print
    PAUSE
    # Move to a safe position for filament change
    G91
    G1 Z{Z} F3000
    G90
    G1 X{X} Y{Y} F3000
    # Heat the hotend to the desired temperature for filament change
    M117 Heating to {TEMP}°C for filament change...
    M109 S{TEMP}  ; Wait for the nozzle to reach temperature
    M117 Nozzle at {TEMP}°C. Remove filament and insert new filament.
    # Unload filament
    G91
    G1 E-50 F2000  ; Large retraction to remove filament
    G1 E-40 F1000  ; Additional retraction if necessary
    G90
    M400
    # Beep to alert user
    M300 S300 P1000
    # Wait for user action (e.g., inserting new filament)
    M117 Insert new filament and press Resume to continue
    # Re-enable filament sensor (if applicable)
    SET_FILAMENT_SENSOR SENSOR=fsensor ENABLE=1
    # Restore printer state
    RESTORE_GCODE_STATE NAME=M600_state
    # Confirm resume
    M117 Filament change completed. Resuming print...
