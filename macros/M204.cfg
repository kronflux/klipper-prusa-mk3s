[gcode_macro M204]
rename_existing: M204.1
gcode:
  {% set f = params.F|default(0.5)|float %}
  
  {% if 'S' in params %}
    {% set s = params.S|float %}
    SET_VELOCITY_LIMIT ACCEL={s} ACCEL_TO_DECEL={s * f}
    {action_respond_info("Set general acceleration to {s} mm/s²")}
  {% elif 'P' in params %}
    {% set p = params.P|float %}
    {% if 'T' in params %}
      {% set t = params.T|float %}
      {% set accel = p if p < t else t %}
      SET_VELOCITY_LIMIT ACCEL={accel} ACCEL_TO_DECEL={accel * f}
      {action_respond_info("Set acceleration to {accel} mm/s² (P={p}, T={t})")}
    {% else %}
      SET_VELOCITY_LIMIT ACCEL={p} ACCEL_TO_DECEL={p * f}
      {action_respond_info("Set print acceleration to {p} mm/s²")}
    {% endif %}
  {% elif 'T' in params %}
    {% set t = params.T|float %}
    SET_VELOCITY_LIMIT ACCEL={t} ACCEL_TO_DECEL={t * f}
    {action_respond_info("Set travel acceleration to {t} mm/s²")}
  {% else %}
    {action_respond_info("M204 command received without S, P, or T parameters. No acceleration changes applied.")}
  {% endif %}
